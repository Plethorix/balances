<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DeFi Monitor ‚Äì Morpho, Aave & Euler</title>

  <!-- Librer√≠as -->
  <script src="libs/ethers.umd.min.js"></script>
  <script src="libs/chart.umd.min.js"></script>

  <style>
    body {
      background-color: #0f172a;
      color: #f1f5f9;
      font-family: "Inter", sans-serif;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .card {
      background-color: #1e293b;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
    }
    input, button {
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
    }
    input {
      width: 300px;
      background-color: #334155;
      color: #f1f5f9;
    }
    button {
      background-color: #2563eb;
      color: white;
      cursor: pointer;
      margin-left: 10px;
    }
    button:hover {
      background-color: #1d4ed8;
    }
    canvas {
      background: transparent;
    }
  </style>
</head>
<body>
  <h1>DeFi Dashboard ‚Äì Morpho, Aave & Euler (Arbitrum)</h1>

  <div class="card">
    <p><strong>Direcci√≥n del usuario:</strong></p>
    <input type="text" id="userAddress" placeholder="0x..." />
    <button onclick="updateBalances()">Consultar</button>
  </div>

  <div class="card">
    <p><strong>Dep√≥sitos Morpho:</strong> <span id="morphoBalance">0.000000</span> USDC</p>
    <p><strong>Dep√≥sitos Aave:</strong> <span id="aaveBalance">0.000000</span> USDC</p>
    <p><strong>Dep√≥sitos Euler:</strong> <span id="eulerBalance">0.000000</span> USDC</p>
    <p><strong>Deuda Aave:</strong> <span id="debtBalance">0.000000</span> USDC</p>
    <hr>
    <p><strong>Posici√≥n neta:</strong> <span id="netBalance">0.000000</span> USDC</p>
  </div>

  <div class="card">
    <p><strong>APY Morpho:</strong> <span id="morphoApy">0.00%</span></p>
    <p><strong>APY Aave:</strong> <span id="aaveApy">0.00%</span></p>
    <p><strong>APY Euler:</strong> <span id="eulerApy">0.00%</span></p>
    <hr>
    <p><strong>APY Total:</strong> <span id="totalApy">0.00%</span></p>
  </div>

  <div class="card">
    <canvas id="apyChart" height="120"></canvas>
  </div>

  <script>
    // ‚úÖ Conexi√≥n RPC (Arbitrum)
    const provider = new ethers.WebSocketProvider("wss://arbitrum-one-rpc.publicnode.com");

    // Direcciones
    const MORPHO_DEFAULT = "0x7e97fa6893871A2751B5fE961978DCCb2c201E65";
    const AAVE_USDC = "0x724dc807b04555b71ed48a6896b6f41593b8c637";
    const AAVE_DEBT = "0xf611aeb5013fd2c0511c9cd55c7dc5c1140741a6";
    const EULER_USDC_EARN = "0xe4783824593a50Bfe9dc873204CEc171ebC62dE0";

    const REFRESH_INTERVAL_MINUTES = 0.5;
    const PERIODS_PER_YEAR = 525600 / REFRESH_INTERVAL_MINUTES;

    const erc20Abi = [
      "function balanceOf(address account) view returns (uint256)",
      "function convertToAssets(uint256 shares) view returns (uint256)"
    ];

    let history = [];

    // üé® Configuraci√≥n del gr√°fico
    const ctx = document.getElementById("apyChart").getContext("2d");
    const apyChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          { label: "APY Morpho", borderColor: "#22c55e", data: [], tension: 0.25, borderWidth: 2, fill: false },
          { label: "APY Aave", borderColor: "#3b82f6", data: [], tension: 0.25, borderWidth: 2, fill: false },
          { label: "APY Euler", borderColor: "#facc15", data: [], tension: 0.25, borderWidth: 2, fill: false },
          { label: "APY Total", borderColor: "#e5e7eb", data: [], tension: 0.25, borderWidth: 2, fill: false }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, title: { display: true, text: "APY (%)", color: "#f1f5f9" }, ticks: { color: "#f1f5f9" }, grid: { color: "#334155" } },
          x: { title: { display: true, text: "Tiempo (intervalos de 30s)", color: "#f1f5f9" }, ticks: { color: "#f1f5f9" }, grid: { color: "#334155" } }
        },
        plugins: { legend: { labels: { color: "#f1f5f9" } } }
      }
    });

    async function fetchBalances() {
      const userAddress = document.getElementById("userAddress").value.trim();
      if (!userAddress) return;

      try {
        const morpho = new ethers.Contract(MORPHO_DEFAULT, erc20Abi, provider);
        const aave = new ethers.Contract(AAVE_USDC, erc20Abi, provider);
        const debt = new ethers.Contract(AAVE_DEBT, erc20Abi, provider);
        const euler = new ethers.Contract(EULER_USDC_EARN, erc20Abi, provider);

        // üîπ Lectura de balances
        const [morphoShares, aaveBal, debtBal, eulerShares] = await Promise.all([
          morpho.balanceOf(userAddress),
          aave.balanceOf(userAddress),
          debt.balanceOf(userAddress),
          euler.balanceOf(userAddress)
        ]);

        const [morphoAssets, eulerAssets] = await Promise.all([
          morpho.convertToAssets(morphoShares),
          euler.convertToAssets(eulerShares)
        ]);

        const morphoUSDC = Number(ethers.formatUnits(morphoAssets, 6));
        const aaveUSDC = Number(ethers.formatUnits(aaveBal, 6));
        const debtUSDC = Number(ethers.formatUnits(debtBal, 6));
        const eulerUSDC = Number(ethers.formatUnits(eulerAssets, 6));

        const net = morphoUSDC + aaveUSDC + eulerUSDC - debtUSDC;

        // üîπ Deltas y APYs
        let morphoDelta = 0, aaveDelta = 0, eulerDelta = 0, netDelta = 0;
        if (history.length > 0) {
          morphoDelta = morphoUSDC - history[history.length - 1].morpho;
          aaveDelta   = aaveUSDC   - history[history.length - 1].aave;
          eulerDelta  = eulerUSDC  - history[history.length - 1].euler;
          netDelta    = net        - history[history.length - 1].net;
        }

        const morphoApy = history.length > 0 && history[history.length - 1].morpho > 0 ? ((1 + morphoDelta / history[history.length - 1].morpho) ** PERIODS_PER_YEAR - 1) * 100 : 0;
        const aaveApy   = history.length > 0 && history[history.length - 1].aave > 0   ? ((1 + aaveDelta / history[history.length - 1].aave) ** PERIODS_PER_YEAR - 1) * 100 : 0;
        const eulerApy  = history.length > 0 && history[history.length - 1].euler > 0  ? ((1 + eulerDelta / history[history.length - 1].euler) ** PERIODS_PER_YEAR - 1) * 100 : 0;
        const totalApy  = history.length > 0 && history[history.length - 1].net > 0    ? ((1 + netDelta / history[history.length - 1].net) ** PERIODS_PER_YEAR - 1) * 100 : 0;

        // üîπ Guardar y limitar historial
        history.push({ morpho: morphoUSDC, aave: aaveUSDC, euler: eulerUSDC, debt: debtUSDC, net, morphoApy, aaveApy, eulerApy, totalApy });
        if (history.length > 50) history.shift();

        // üîπ Mostrar datos
        document.getElementById("morphoBalance").innerText = morphoUSDC.toFixed(6);
        document.getElementById("aaveBalance").innerText   = aaveUSDC.toFixed(6);
        document.getElementById("eulerBalance").innerText  = eulerUSDC.toFixed(6);
        document.getElementById("debtBalance").innerText   = debtUSDC.toFixed(6);
        document.getElementById("netBalance").innerText    = net.toFixed(6);

        document.getElementById("morphoApy").innerText = morphoApy.toFixed(2) + "%";
        document.getElementById("aaveApy").innerText   = aaveApy.toFixed(2) + "%";
        document.getElementById("eulerApy").innerText  = eulerApy.toFixed(2) + "%";
        document.getElementById("totalApy").innerText  = totalApy.toFixed(2) + "%";

        // üîπ Actualizar gr√°fico
        apyChart.data.labels.push(history.length.toString());
        apyChart.data.datasets[0].data.push(morphoApy);
        apyChart.data.datasets[1].data.push(aaveApy);
        apyChart.data.datasets[2].data.push(eulerApy);
        apyChart.data.datasets[3].data.push(totalApy);

        if (apyChart.data.labels.length > 50) {
          apyChart.data.labels.shift();
          apyChart.data.datasets.forEach(ds => ds.data.shift());
        }

        apyChart.update();

      } catch (err) {
        console.error("Error al obtener balances:", err);
      }
    }

    function updateBalances() {
      fetchBalances();
      setInterval(fetchBalances, 30000);
    }
  </script>
</body>
</html>
