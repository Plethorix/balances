<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Morpho + Aave Dashboard (Arbitrum)</title>
<link rel="stylesheet" href="style.css">

<!-- Ethers.js desde GitHub Pages -->
<script src="https://plethorix.github.io/balances/libs/ethers.umd.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>Morpho + Aave Dashboard (Arbitrum)</h1>

<div class="form-container">
  <input type="text" id="ethAddress" placeholder="Dirección ETH">
  <input type="text" id="vaultAddress" placeholder="Vault Morpho" value="0x7e97fa6893871A2751B5fE961978DCCb2c201E65">
  <button onclick="updateBalances()">Actualizar</button>
</div>

<div class="stats">
  <p><strong>Depósitos Morpho (USDC):</strong> <span id="deposits">0.000000</span></p>
  <p><strong>Depósitos Aave USDC:</strong> <span id="aaveDeposits">0.000000</span></p>
  <p><strong>Deuda Aave (USDC):</strong> <span id="debt">0.000000</span></p>
  <p><strong>Net Position (USDC):</strong> <span id="net">0.000000</span></p>
</div>

<canvas id="chart" width="800" height="300"></canvas>

<script>
// ===== CONFIG =====
const ARBITRUM_RPC = "https://arb1.arbitrum.io/rpc";
const AAVE_USDC_DEBT = "0xf611aeb5013fd2c0511c9cd55c7dc5c1140741a6";
const AAVE_USDC_DEPOSITS = "0x724dc807b04555b71ed48a6896b6f41593b8c637";

// ===== ABIs =====
const erc20Abi = [
  {"constant":true,"inputs":[{"name":"account","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"type":"function"}
];

const morphoVaultAbi = [
  {"constant":true,"inputs":[{"name":"account","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"type":"function"},
  {"constant":true,"inputs":[{"name":"shares","type":"uint256"}],"name":"convertToAssets","outputs":[{"name":"","type":"uint256"}],"type":"function"}
];

// ===== PROVIDER =====
const provider = new window.ethers.JsonRpcProvider(ARBITRUM_RPC);

// ===== VARIABLES =====
let history = [];
let chart;

// ===== FUNCIONES =====
function initChart() {
  const ctx = document.getElementById('chart').getContext('2d');
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: '% Cambio', data: [], borderColor: '#4caf50', backgroundColor: '#4caf5020', fill: true },
        { label: 'APY anual %', data: [], borderColor: '#ff9800', backgroundColor: '#ff980020', fill: true }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: '#fff' } },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        x: { ticks: { color: '#fff' }, grid: { color: '#555' } },
        y: { ticks: { color: '#fff' }, grid: { color: '#555' } }
      }
    }
  });
}

async function fetchBalances(ethAddress, vaultAddress) {
  if (!window.ethers.isAddress(ethAddress)) return;

  try {
    // ===== MORPHO =====
    const morphoVault = new window.ethers.Contract(vaultAddress, morphoVaultAbi, provider);
    const shares = await morphoVault.balanceOf(ethAddress);
    const depositedRaw = await morphoVault.convertToAssets(shares);
    const deposited = parseFloat(window.ethers.formatUnits(depositedRaw, 6));

    // ===== AAVE DEPOSITS =====
    const aaveDepositsContract = new window.ethers.Contract(AAVE_USDC_DEPOSITS, erc20Abi, provider);
    const aaveDepositsRaw = await aaveDepositsContract.balanceOf(ethAddress);
    const aaveDeposits = parseFloat(window.ethers.formatUnits(aaveDepositsRaw, 6));

    // ===== AAVE DEUDA =====
    const aaveDebtContract = new window.ethers.Contract(AAVE_USDC_DEBT, erc20Abi, provider);
    const debtRaw = await aaveDebtContract.balanceOf(ethAddress);
    const debt = parseFloat(window.ethers.formatUnits(debtRaw, 6));

    const net = deposited + aaveDeposits - debt;

    // ===== % Cambio y APY =====
    let delta = 0;
    if (history.length > 0) delta = net - history[history.length - 1].net;
    const porcentaje = history.length > 0 ? (delta / history[history.length - 1].net) * 100 : 0;
    const apy = history.length > 0 ? ((1 + delta / history[history.length - 1].net) ** 525600 -1)*100 : 0;

    history.push({ net, porcentaje, apy, time: new Date().toLocaleTimeString() });
    if (history.length > 60) history.shift();

    // ===== ACTUALIZAR UI =====
    document.getElementById('deposits').innerText = deposited.toFixed(6);
    document.getElementById('aaveDeposits').innerText = aaveDeposits.toFixed(6);
    document.getElementById('debt').innerText = debt.toFixed(6);
    document.getElementById('net').innerText = net.toFixed(6);

    // ===== ACTUALIZAR GRÁFICO =====
    chart.data.labels = history.map(h => h.time);
    chart.data.datasets[0].data = history.map(h => h.porcentaje);
    chart.data.datasets[1].data = history.map(h => h.apy);
    chart.update();

  } catch(e) {
    console.error("Error fetching balances:", e);
  }
}

function updateBalances() {
  const ethAddress = document.getElementById('ethAddress').value.trim();
  const vaultAddress = document.getElementById('vaultAddress').value.trim();
  fetchBalances(ethAddress, vaultAddress);
}

// ===== INICIALIZAR =====
initChart();
setInterval(() => {
  const ethAddress = document.getElementById('ethAddress').value.trim();
  const vaultAddress = document.getElementById('vaultAddress').value.trim();
  fetchBalances(ethAddress, vaultAddress);
}, 60000);

</script>
</body>
</html>
