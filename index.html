<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Morpho + Aave Dashboard (Arbitrum)</title>
<link rel="stylesheet" href="style.css">
<!-- Ethers.js -->
<script src="https://cdn.ethers.io/lib/ethers-6.9.0.min.js" type="text/javascript"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>Morpho + Aave Dashboard (Arbitrum)</h1>

<div class="form-container">
  <input type="text" id="ethAddress" placeholder="Dirección ETH">
  <input type="text" id="vaultAddress" placeholder="Vault Morpho" value="0x7e97fa6893871A2751B5fE961978DCCb2c201E65">
  <button onclick="updateBalances()">Actualizar</button>
</div>

<div class="stats">
  <p><strong>Depósitos Morpho (USDC):</strong> <span id="deposits">0</span></p>
  <p><strong>Deuda Aave (USDC):</strong> <span id="debt">0</span></p>
  <p><strong>Net Position (USDC):</strong> <span id="net">0</span></p>
</div>

<canvas id="chart" width="800" height="300"></canvas>

<script src="abi/erc20.json"></script>
<script src="abi/morphoVault.json"></script>
<script>
// Configuración
const ARBITRUM_RPC = "https://arb1.arbitrum.io/rpc";
const AAVE_USDC = "0xf611aeb5013fd2c0511c9cd55c7dc5c1140741a6";

const erc20Abi = [
  {"constant":true,"inputs":[{"name":"account","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"type":"function"}
];

const morphoVaultAbi = [
  {"constant":true,"inputs":[{"name":"account","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"type":"function"},
  {"constant":true,"inputs":[{"name":"shares","type":"uint256"}],"name":"convertToAssets","outputs":[{"name":"","type":"uint256"}],"type":"function"}
];

const provider = new ethers.JsonRpcProvider(ARBITRUM_RPC);

let history = [];
let chart;

function initChart() {
  const ctx = document.getElementById('chart').getContext('2d');
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: '% Cambio', data: [], borderColor: '#8884d8', fill: false },
        { label: 'APY anual %', data: [], borderColor: '#82ca9d', fill: false }
      ]
    },
    options: { responsive: true, scales: { y: { beginAtZero: false } } }
  });
}

async function fetchBalances(ethAddress, vaultAddress) {
  if (!ethers.isAddress(ethAddress)) return;

  // Morpho
  const morphoVault = new ethers.Contract(vaultAddress, morphoVaultAbi, provider);
  const shares = await morphoVault.balanceOf(ethAddress);
  const depositedRaw = await morphoVault.convertToAssets(shares);
  const deposited = parseFloat(ethers.formatUnits(depositedRaw, 6));

  // Aave USDC
  const aaveUsdc = new ethers.Contract(AAVE_USDC, erc20Abi, provider);
  const debtRaw = await aaveUsdc.balanceOf(ethAddress);
  const debt = parseFloat(ethers.formatUnits(debtRaw, 6));

  const net = deposited - debt;

  let delta = 0;
  if (history.length > 0) delta = net - history[history.length - 1].net;
  const porcentaje = history.length > 0 ? (delta / history[history.length - 1].net) * 100 : 0;
  const apy = history.length > 0 ? ((1 + delta / history[history.length - 1].net) ** 525600 -1)*100 : 0;

  history.push({ net, porcentaje, apy, time: new Date().toLocaleTimeString() });
  if (history.length > 60) history.shift();

  document.getElementById('deposits').innerText = deposited.toFixed(2);
  document.getElementById('debt').innerText = debt.toFixed(2);
  document.getElementById('net').innerText = net.toFixed(2);

  chart.data.labels = history.map(h => h.time);
  chart.data.datasets[0].data = history.map(h => h.porcentaje);
  chart.data.datasets[1].data = history.map(h => h.apy);
  chart.update();
}

function updateBalances() {
  const ethAddress = document.getElementById('ethAddress').value.trim();
  const vaultAddress = document.getElementById('vaultAddress').value.trim();
  fetchBalances(ethAddress, vaultAddress);
}

initChart();
setInterval(() => {
  const ethAddress = document.getElementById('ethAddress').value.trim();
  const vaultAddress = document.getElementById('vaultAddress').value.trim();
  fetchBalances(ethAddress, vaultAddress);
}, 60000);
</script>
</body>
</html>
